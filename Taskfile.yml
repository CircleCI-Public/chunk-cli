version: '3'

tasks:
  nur:publish:
    desc: Publish the Nix package to NUR (Nix User Repository)
    vars:
      NUR_DIR: /tmp/nur-packages
    cmds:
      # Clone NUR packages repository
      - git clone https://github.com/CircleCI-Public/nur-packages.git {{.NUR_DIR}}

      # Configure git
      - git -C {{.NUR_DIR}} config user.name "CircleCI Bot"
      - git -C {{.NUR_DIR}} config user.email "noreply@circleci.com"

      # Create package directory and copy the template generated by GoReleaser
      - mkdir -p {{.NUR_DIR}}/pkgs/chunk
      - cp dist/nix/pkgs/chunk/default.nix {{.NUR_DIR}}/pkgs/chunk/

      # Update URLs to point to the release tag
      - sed -i "s|/v[0-9.]*-next/|/${CIRCLE_TAG}/|g" {{.NUR_DIR}}/pkgs/chunk/default.nix
      - sed -i "s|/v[0-9.][0-9.]*[0-9]/|/${CIRCLE_TAG}/|g" {{.NUR_DIR}}/pkgs/chunk/default.nix

      # Calculate and update SHA256 hashes from local archives
      - |
        echo "Calculating SHA256 hashes from local archives..."
        for platform in "Linux_x86_64:x86_64-linux" "Linux_arm64:aarch64-linux" "Darwin_x86_64:x86_64-darwin" "Darwin_arm64:aarch64-darwin"; do
          archive=$(echo $platform | cut -d: -f1)
          nixname=$(echo $platform | cut -d: -f2)
          archive_path="dist/chunk_${archive}.tar.gz"
          echo "Hashing $archive_path..."
          sha=$(nix-hash --type sha256 --flat --base32 "$archive_path")
          sed -i "/shaMap = {/,/^  };/s|${nixname} = \"[^\"]*\"|${nixname} = \"${sha}\"|" {{.NUR_DIR}}/pkgs/chunk/default.nix
        done

      # Update version
      - sed -i "s|version = \"[^\"]*\"|version = \"${CIRCLE_TAG#v}\"|g" {{.NUR_DIR}}/pkgs/chunk/default.nix

      # Copy flake.nix if it doesn't exist
      - |
        if [ ! -f {{.NUR_DIR}}/flake.nix ]; then
          cp flake.nix {{.NUR_DIR}}/
          git -C {{.NUR_DIR}} add flake.nix
        fi

      # Commit and push
      - git -C {{.NUR_DIR}} add pkgs/chunk/default.nix
      - git -C {{.NUR_DIR}} commit -m "Update chunk to ${CIRCLE_TAG}" || echo "No changes to commit"
      - git -C {{.NUR_DIR}} push https://${GITHUB_TOKEN}@github.com/CircleCI-Public/nur-packages.git main
